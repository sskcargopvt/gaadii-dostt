<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Connection Test</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: bold;
        }

        .status.connected {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        .status.waiting {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffeaa7;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin: 10px 5px;
        }

        button:hover {
            background: #0056b3;
        }

        button.danger {
            background: #dc3545;
        }

        button.danger:hover {
            background: #c82333;
        }

        button.success {
            background: #28a745;
        }

        button.success:hover {
            background: #218838;
        }

        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .log-entry {
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
        }

        .log-entry.success {
            background: #d4edda;
            color: #155724;
        }

        .log-entry.error {
            background: #f8d7da;
            color: #721c24;
        }

        .log-entry.info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .log-entry.broadcast {
            background: #fff3cd;
            color: #856404;
            font-weight: bold;
        }

        .section {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .section h2 {
            margin-top: 0;
            color: #495057;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üîç Real-Time Connection Test</h1>
        <p>This tool tests the real-time connection between your customer and driver apps.</p>

        <div id="status" class="status waiting">
            ‚è≥ Waiting to connect...
        </div>

        <div class="section">
            <h2>Step 1: Subscribe to Broadcasts</h2>
            <button onclick="subscribeToBookings()" class="success">üîå Connect to booking_requests</button>
            <button onclick="unsubscribe()" class="danger">üîå Disconnect</button>
        </div>

        <div class="section">
            <h2>Step 2: Test Trigger</h2>
            <p>This will insert a test booking into the database. If the trigger works, you'll see a broadcast message
                below.</p>
            <button onclick="insertTestBooking()">üì¢ Insert Test Booking</button>
        </div>

        <div class="section">
            <h2>Step 3: Check Database</h2>
            <button onclick="fetchBookings()">üìä Fetch All Bookings</button>
            <button onclick="clearLog()">üóëÔ∏è Clear Log</button>
        </div>

        <div class="log" id="log">
            <div class="log-entry info">üìù Logs will appear here...</div>
        </div>
    </div>

    <div style="margin-top: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px;">
        <h3>üì§ Send Test Broadcast</h3>
        <button onclick="sendTestBroadcast()"
            style="background: #0284c7; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
            Send Test Request
        </button>
        <div id="send-status" style="margin-top: 10px; font-size: 14px;"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://tstboympleybwbdwicik.supabase.co';
        // Using the key extracted from your previous file versions
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRzdGJveW1wbGV5YndiZHdpY2lrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2NDg0OTcsImV4cCI6MjA4NDIyNDQ5N30.JQZFd3z4yrVeUHG66Pe_FGFnupoG6JfguEP8auY-qUE';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function sendTestBroadcast() {
            const statusDiv = document.getElementById('send-status');
            statusDiv.textContent = 'Connecting...';

            try {
                const channel = supabase.channel('booking_requests');
                channel.subscribe(async (status) => {
                    if (status === 'SUBSCRIBED') {
                        statusDiv.textContent = 'Connected! Sending test...';
                        await channel.send({
                            type: 'broadcast',
                            event: 'INSERT',
                            payload: {
                                type: 'INSERT',
                                new: { id: 'TEST-' + Date.now(), status: 'pending', customer_name: 'TEST TOOL' }
                            }
                        });
                        statusDiv.textContent = '‚úÖ Sent! If you see it below, permissions are fixed.';
                        // Keep channel open briefly
                        setTimeout(() => supabase.removeChannel(channel), 2000);
                    } else if (status === 'CHANNEL_ERROR') {
                        statusDiv.textContent = '‚ùå Connection Error! You MUST run FIX_BROADCAST_PERMISSION.sql';
                    }
                });
            } catch (e) {
                statusDiv.textContent = 'Error: ' + e.message;
            }
        }
        let channel = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(message, connected) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = connected ? 'status connected' : 'status disconnected';
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '<div class="log-entry info">üìù Log cleared</div>';
        }

        async function subscribeToBookings() {
            if (channel) {
                log('‚ö†Ô∏è Already subscribed. Disconnect first.', 'error');
                return;
            }

            log('üîå Attempting to subscribe to booking_requests...', 'info');

            const topic = 'booking_requests';
            channel = supabase.channel(topic, {
                config: { private: true, broadcast: { self: false } }
            });

            channel
                .on('broadcast', { event: '*' }, (payload) => {
                    log('üì¢ BROADCAST RECEIVED!', 'broadcast');
                    log(JSON.stringify(payload, null, 2), 'broadcast');

                    const type = payload.type || payload.event;
                    const newRow = payload.new ?? payload.new_row ?? payload.payload;

                    if (type === 'INSERT' && newRow) {
                        log(`‚úÖ New booking: ${newRow.customer_name} - ${newRow.pickup_location}`, 'success');
                    }
                })
                .subscribe((status) => {
                    if (status === 'SUBSCRIBED') {
                        log('‚úÖ Successfully subscribed to booking_requests (broadcast mode)', 'success');
                        updateStatus('‚úÖ Connected and listening for broadcasts', true);
                    } else if (status === 'CHANNEL_ERROR') {
                        log('‚ùå Channel error - check RLS policies or authentication', 'error');
                        updateStatus('‚ùå Connection failed', false);
                    } else {
                        log(`üì° Channel status: ${status}`, 'info');
                    }
                });
        }

        function unsubscribe() {
            if (channel) {
                supabase.removeChannel(channel);
                channel = null;
                log('üîå Disconnected from booking_requests', 'info');
                updateStatus('‚è≥ Disconnected', false);
            } else {
                log('‚ö†Ô∏è Not connected', 'error');
            }
        }

        async function insertTestBooking() {
            log('üìù Inserting test booking...', 'info');

            try {
                const { data, error } = await supabase
                    .from('booking_requests')
                    .insert([{
                        customer_name: 'TEST CUSTOMER ' + Date.now(),
                        customer_phone: '9999999999',
                        pickup_location: 'Test Pickup Location',
                        drop_location: 'Test Drop Location',
                        pickup_lat: 28.6274,
                        pickup_lng: 77.3725,
                        drop_lat: 28.4744,
                        drop_lng: 77.5030,
                        goods_type: 'Test Goods',
                        weight: '100',
                        offered_price: '5000',
                        status: 'pending',
                        messages: []
                    }])
                    .select()
                    .single();

                if (error) throw error;

                log(`‚úÖ Test booking inserted! ID: ${data.id}`, 'success');
                log('üëÄ If the trigger works, you should see a broadcast message above!', 'info');
            } catch (err) {
                log(`‚ùå Error inserting booking: ${err.message}`, 'error');
            }
        }

        async function fetchBookings() {
            log('üìä Fetching all bookings...', 'info');

            try {
                const { data, error } = await supabase
                    .from('booking_requests')
                    .select('id, customer_name, pickup_location, status, created_at')
                    .order('created_at', { ascending: false })
                    .limit(5);

                if (error) throw error;

                log(`‚úÖ Found ${data.length} bookings:`, 'success');
                data.forEach((booking, index) => {
                    log(`${index + 1}. ${booking.customer_name} - ${booking.pickup_location} (${booking.status})`, 'info');
                });
            } catch (err) {
                log(`‚ùå Error fetching bookings: ${err.message}`, 'error');
            }
        }

        // Auto-connect on page load
        window.addEventListener('load', () => {
            log('üöÄ Test tool loaded. Click "Connect" to start.', 'info');
        });
    </script>
</body>

</html>